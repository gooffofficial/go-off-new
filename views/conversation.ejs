<!DOCTYPE html>
<html>

<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-180244749-2"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		window.onload = function() {
			console.log("SDASDASDASDASD");
		}
		function gtag() {
			dataLayer.push(arguments);
		}
		gtag('js', new Date());

		gtag('config', 'UA-180244749-2');
	</script>
	<link id="pro-style" rel="stylesheet" href="/css/conversation.css">
	<link rel="stylesheet" href="/css/navigationBar.css">

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
		integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
		integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous">
	</script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
		integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
	</script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
		integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
	</script>
	<script src="/convoCreate.js"></script>
	<!-- <script type="text/javascript" src="profile.js"></script> -->
	<title>Profile Page</title>
</head>

<body onload="fillinvar()">
	<nav class="navigationBar d-flex">
		<div class="navigationContainer d-flex">
			<a href="/feed"><img src="/GO_OFF_LOGO.svg" class="navigationLogo align-self-center" style="margin-top: 10px"></a>

			<div class="navigationIcons align-self-center">
				<!--<a href=""><img src="/plus.svg" class="navIcon"></a>-->
				<div class="droparrow align-self-center">
					<div id="plusdrop" class="dropdown-arrowcontent" style="position: absolute; top: 25px;">
						<a data-target="#add-media" data-toggle="modal" class="MainNavText" id="media-adder"
							style="display: inline-block;" href="#add-media">Media</a>
						<!--<a href="/following" target="_blank" id="following-count" style="display: inline-block;"></a>-->
						<!-- Modal -->
						<div class="modal fade" id="add-media" tabindex="-1" role="dialog"
							aria-labelledby="exampleModalLabel" aria-hidden="true">
							<div class="modal-dialog" role="document">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title" id="exampleModalLabel">Media</h5>
										<button type="button" class="close" data-dismiss="modal" aria-label="Close">
											<span aria-hidden="true">&times;</span>
										</button>
									</div>
									<div class="modal-body">
										<form action="/api/users/add_article" method="post">
											<label class="url-label" for="userArticle">URL</label><br>
											<input type="text" id="userArticle" name="userArticle">
											<input type="submit" value="Submit" class="submit-btn">
										</form>
									</div>
								</div>
							</div>
						</div>
						<br>
						<!-- <a href="/profile_edit">Folder</a> -->
						<a data-target="#add-convo" data-toggle="modal" class="MainNavText" id="convobtn"
							style="display: inline-block; visibility: hidden;" href="#add-convo">Convo</a>
						<!-- Modal -->
						<div class="modal fade" id="add-convo" tabindex="-1" role="dialog"
							aria-labelledby="exampleModalLabelConv" aria-hidden="true">
							<div class="modal-dialog" role="document">
								<div class="modal-content">
									<div class="modal-header">
										<h5 class="modal-title" id="exampleModalLabelConv">Convo</h5>
										<button type="button" class="close" data-dismiss="modal" aria-label="Close">
											<span aria-hidden="true">&times;</span>
										</button>
									</div>
									<div class="modal-body" style="width: min-content;">
										<form action="/api/convos/create" method="post" id="createConvoBar">
											<label for="convoTime">Conversation Time</label>
											<input type="datetime-local" id="convoTime">
											<input type="hidden" id="datetime-bar" name="convoTime" value="">
											<input type="hidden" id="timezone" name="tz" value="">
											<label for="convoTitle">Convo Title</label>
											<input type="text" id="convoTitle" name="convoTitle">
											<label for="convoDesc">Convo Description</label>
											<input type="text" id="convoDesc" name="convoDesc">
											<!-- Sus security here -->
											<label for="article">Article URL</label>
											<input type="text" id="article" name="article">
											<!--<input type="submit" value="submit">-->
											<button onclick="createConvoBar()">Create</button>
										</form>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<a href="/feed"><img src="/home.svg" class="navIcon"></a>
				<!-- <a href=""><img src="/mail.svg" class="navIcon"></a> -->
				<a href="#" id="notif" onclick="dropclick1('notif-dropdown')"><img src="/notification.svg" class="navIcon"></a>
				<div id="notif-dropdown" class="dropdown-arrowcontent" style="position: absolute; top: 25px;">
					
				</div>
				<!-- <a href=""><img src="/chart.svg" class="navIcon"></a> -->
				<img onclick="dropclick1('plusdrop')" src="/plus.svg" class="navIcon">
			</div>

			<div class="searchContainer align-self-center d-flex">
				<!-- <form id="bar_form"> SEARCH BAR NEEDS TO BE CONNECTED -->
				<img src="/search_icon.svg" class="search-icon align-self-center">
				<input type="text" id="search" placeholder="Search" autocomplete="off" onkeyup="plsWork(this.value)">
				<!-- </form> -->
				<!--<p>Suggestions: <span id="txtHint"></span></p>-->
			</div>

			<div id="search-input-results" style="visibility: hidden">
				<a id="search-1"></a>
				<a id="search-2"></a>
				<a id="search-3"></a>
				<a id="search-4"></a>
				<a id="search-5"></a>
			</div>

			<div class="navigationProfile d-flex">
				<div class="align-self-center">
					<a href="/profiles/<%=user%>">
						<img id="fprofpic" src="https://miro.medium.com/max/316/1*LGHbA9o2BKka2obwwCAjWg.jpeg"
							class="navigationProfilePic">
						<p class="navigationProfileName"></p>

						<span id="pname"></span>
					</a>
				</div>

				<div class="droparrow align-self-center">
					<img onclick="dropclick1('arrowdrop')" src="/chevron_down.svg" id="arrows" />
					<div id="arrowdrop" class="dropdown-arrowcontent">
						<a id="profbutton" href = "/profiles/<%=user%>">Profile</a>
						<a href="/profile_edit">Settings</a>
						<a href="https://www.go-off.co/">Log Out</a>
					</div>
				</div>
			</div>
		</div>
	</nav>

	<div class="pageContainer">
		<div class="top-box">
			<div id="article-img-container">
				<img id="article-pic" src="<%=articlePic%>">
			</div>

			<div id="article-edit-container">
				<img src="/pencil.svg" id="edit-icon">
				<a id="sharable" >
				<img src="/share_outline.svg" id="edit-icon"> </a>
				<a href="<%=artLink%>" target="_blank" id="article-link">Article link</a>

				<!--<img src="https://miro.medium.com/max/316/1*LGHbA9o2BKka2obwwCAjWg.jpeg" id="img-pfp1">
				<span id="user-name">User Name</span>-->
			</div>

			<div id="article-info-container">
				<img src="https://miro.medium.com/max/316/1*LGHbA9o2BKka2obwwCAjWg.jpeg" id="img-pfp2">
				<!-- <span id="article-publisher">New York Times</span>
				<span id="article-dater">2d</span> -->

				<h1 id="article-title"><%=artTitle%></h1>
				<!-- <p id="article-desc">Description</p> -->
			</div>

			<!-- COMMENTED OUT ORIGINAL!! -->
			 <!-- <div id="article-info-container"></div>
				<a href="<%=artLink%>" id="article-link">article link</a>
				<h1 id="article-title"><%=artTitle%></h1>
				<button onclick="joinConvo()">RSVP</button>
			</div>  -->
		</div>

		<div id="convos-container">
			<div class="tab" id="tabs-container">
				<hr id="tablink-line">
				<button class="tablinks1 active">Upcoming Convos</button>
				<!-- <button class="tablinks1">Previous Convos</button> -->
				<button type="button" id="create-convo-btn" onclick="dropmodal()" style="visibility: hidden;">Create Convo</button>
				<div id="arrowdropmodal" class="dropdown-arrowcontent" style="width: min-content;">
					<form id="createConvo" method="post" action="/api/convos/create">
						<label for="convoTime">Conversation Time</label>
						<input type="datetime-local" min=<%=date%> id="convoTimeMain">
						<input type="hidden" id="timezone2" name="tz" value="">
						<input type="hidden" id="datetime" name="convoTime" value="">
						<label for="convoTitle">Convo Title</label>
						<input type="text" id="convoTitle" name="convoTitle">
						<label for="convoDesc">Convo Description</label>
						<input type="text" id="convoDesc" name="convoDesc">
						<!-- Sus security here -->
						<input type="hidden" id="article" name="article" value="<%=artLink%>">
						<!--<input type="submit" value="submit">-->
						<button onclick="submitMain()">Create</button>
					</form>
				</div>
			</div>
			<div id="upcoming_convo" class="tabcontent1">
				<div id="convo-container">
					<div id="convo-img-container">
						<img id="convo-img" src="<%=articlePic%>">
					</div>
					<div id="convo-right-content">
						<p id="convo-date0"><%=convos[0].time%></p>
						<p id="convo-title"><%=convos[0].title%></p>
						<p id="convo-description"><%=convos[0].description%></p>
						<span id="convo-host">Hosted by <%=hosts[0]%></span>
					
						<div id="convo-btns">
							<!-- SHARE BUTTON NO FUNCTIONALITY YET 
							<a><img src="/share_outline.svg" id="convo-share-btn"></a> -->
							<img src="/lightbulb.svg" id="convo-btn-icon">
							<img src="/share_outline.svg" id="convo-btn-icon">
							<button id="go-to-convo-button" onclick="joinConvo1()">RSVP</button>
						</div>
					</div>
				</div>
			</div>
			<div id="upcoming_convo" class="tabcontent1">
				<div id="convo-container">
					<div id="convo-img-container">
						<img id="convo-img" src="<%=articlePic%>">
					</div>
					<div id="convo-right-content">
						<p id="convo-date1"><%=convos[1].time%></p>
						<p id="convo-title"><%=convos[1].title%></p>
						<p id="convo-description"><%=convos[1].description%></p>
						<span id="convo-host">Hosted by <%=hosts[1]%></span>
					
						<div id="convo-btns">
							<!-- SHARE BUTTON NO FUNCTIONALITY YET 
							<a><img src="/share_outline.svg" id="convo-share-btn"></a> -->
							<img src="/lightbulb.svg" id="convo-btn-icon">
							<img src="/share_outline.svg" id="convo-btn-icon">
							<button id="go-to-convo-button" onclick="joinConvo2()">RSVP</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- <div id="rsvp-pop" style="visibility: hidden;"> -->
		<footer>
			<div class="footer-container">
				<img src="/GO_OFF_LOGO.svg" id="footer-logo">
	
				<div class="footer-link-container">
					<a href="https://www.gooffco.com/">
						<button type="submit" id="home">
							Home
						</button>
					</a>
	
					<a
						href="https://docs.google.com/forms/d/e/1FAIpQLScRZFA4owbzMnqmcS2D02LMqHks2RhoQfvfwZpTpcGtOkWwLA/viewform">
						<button type="submit" id="profile">
							Beta Sign Up
						</button>
					</a>
	
					<a href="Mailto:sn23@bu.edu">
						<button type="submit" id="contact">
							Contact us
						</button>
					</a>
				</div>
			</div>
		</footer>

		<!-- <div id="rsvp-pop" style="visibility: hidden;">
			<p>You have succesfully RSVP'd for this conversation! 
				Go to the Conversations Tab on your profile to join!
			</p>
			<a href="/profiles/<%=user%>">
				<button type="submit">Go to Profile</button>
			</a>
		</div> 
		<!-- <div id="arrowdropmodal" class="dropdown-arrowcontent">
			<form id="createConvo" method="post" action="/api/convos/create">
				<label for="convoTime">Conversation Time</label>
				<input type="datetime-local" min=<%=date%> id="convoTime" name="convoTime">
				<input type="hidden" id="article" name="article" value="<%=artLink%>">
				<input type="submit" value="submit">
			</form>
		</div>
		<p id="subheader">Upcoming Convos</p>
		<div class="upcoming-convo1">
			<img id="article-pic1" src="<%=articlePic%>">
			<h1 id="convo-host1">Hosted by: <%=hosts[0]%></h1>
			<p id="convo-time1"><%=convos[0].time%></p>
			<button type="button" onclick="joinConvo1()">RSVP</button>
		</div>
		<div class="upcoming-convo2">
			<img id="article-pic2" src="<%=articlePic%>">
			<h1 id="convo-host2">Hosted by: <%=hosts[1]%></h1>
			<p id="convo-time2"><%=convos[1].time%></p>
			<button type="button" onclick="joinConvo2()">RSVP</button>
		</div> -->
	</div>
	<script>

		function submitMain() {
			var dateInput = new Date(document.getElementById('convoTimeMain').value)
			var epoch = dateInput.getTime();
			//document.getElementById('timezone2').value = dateInput.getTimezoneOffset();
			document.getElementById('datetime').value = epoch;
			document.getElementById('createConvo').submit();
		}

		function dropclick1(id) {
			var x = document.getElementById(id);
			if (x.style.display === "block") {
				x.style.display = "none";
			} else {
				x.style.display = "block";
			}
		}

		function dropclick2() {
			var x = document.getElementById("arrowdrop2");
			if (x.style.display === "block") {
				x.style.display = "none";
			} else {
				x.style.display = "block";
			}
		}

		function dropmodal() {
			var x = document.getElementById("arrowdropmodal");
			if (x.style.display === "block") {
				x.style.display = "none";
			} else {
				x.style.display = "block";
			}
		}

		function joinConvo1() {
			console.log("HEEEEYYYYY");
			var xhr = new XMLHttpRequest();
			xhr.open("POST", '/api/convos/join', true);
			xhr.setRequestHeader('Content-Type', 'application/json');
			xhr.send(JSON.stringify({
				convo: <%=convos[0].id%>
			}));

			window.alert("Successfully RSVP'd! Go to the Conversation tab on your Profile to join!");
		}

		function joinConvo2() {
			console.log("HEEEEYYYYY");
			var xhr = new XMLHttpRequest();
			xhr.open("POST", '/api/convos/join', true);
			xhr.setRequestHeader('Content-Type', 'application/json');
			xhr.send(JSON.stringify({
				convo: <%=convos[1].id%>
			}));
			window.alert("Successfully RSVP'd! Go to the Conversation tab on your Profile to join!");
		}

		var xhrNotif = new XMLHttpRequest();
		xhrNotif.onreadystatechange = function () {
			if (this.readyState == 4 && this.status == 200) {
				var convArr = JSON.parse(this.responseText);
				console.log(convArr);
				console.log(document.getElementById("notif"))
				document.getElementById("notif").innerText = convArr.length
				for	(var i=0; i<convArr.length; i++){
					var notifDiv = document.createElement('div')
					notifDiv.setAttribute('class', 'notification')
					var notifText = document.createElement('p')
					notifText.setAttribute('font-size', 'small')
					notifText.setAttribute('id', 'notiftext')
					var notifTextNode = document.createTextNode('You have a convo "' + convArr[i].title +'" coming up soon!\n Find it on your converations tab.')
					notifText.appendChild(notifTextNode)
					
					notifDiv.appendChild(notifText)
					var linkText = document.createElement('a')
					linkText.setAttribute('href', "/chat/"+convArr[i].roomId)
					notifDiv.appendChild(linkText)
					document.getElementById('notif-dropdown').appendChild(notifDiv)
				}
			}
		}				
		xhrNotif.open("GET", '/api/upcoming', true);
		xhrNotif.withCredentials = true
		xhrNotif.send();
		
		function plsWork(str) {
			str.toLowerCase();
			var stringz = ""
			var count = 1
			if (str.length < 2) {
				document.getElementById('search-input-results').style.visibility = 'hidden';
				document.getElementById("search-1").innerText = "";
				document.getElementById("search-2").innerText = "";
				document.getElementById("search-3").innerText = "";
				document.getElementById("search-4").innerText = "";
				document.getElementById("search-5").innerText = "";
				return;
			} else {
				document.getElementById('search-input-results').style.visibility = 'visible';
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange = function () {
					if (this.readyState == 4 && this.status == 200) {
						var names = JSON.parse(this.responseText);
						console.log(this.responseText);
						for (var i = 0; i < names.length; i++) {
							var obj = names[i].username;
							var na = names[i].name;
							var l_obj = obj.toLowerCase();
							var l_na = na.toLowerCase();
							if (count < 6 && (l_obj.includes(str) || l_na.includes(str))) {
								var search_id = "search-" + count.toString();
								document.getElementById(search_id).setAttribute("href", "/profiles/" + obj);
								document.getElementById(search_id).innerText = na;
								count = count + 1;
							}
						}
					}
				};
				xmlhttp.open("GET", "/api/users/all", true);
				xmlhttp.send();
			}
		}

		function fillinvar(){
			let windowLocation = window.location.href.toString()
			console.log(windowLocation);
			//.slice(22);
			console.log(windowLocation.slice(7,16))
			let mySharable;
			if(windowLocation.slice(7,16) == 'localhost') {
				console.log("This is localhost")
				mySharable = 'localhost:8000/login/?convo=/' + windowLocation.slice(22);
			}else {
				console.log("Deployed")
				mySharable = 'https://go-off.co/login/?convo=/'+  windowLocation.slice(22);
			}
			console.log(windowLocation);
			console.log(mySharable)
			document.getElementById("sharable").onclick = function () { alert("Here is the sharable link: "+ mySharable); };

			if("<%=convos[0].time%>" == "No convo scheduled" || "<%=convos[1].time%>" == "No convo scheduled"){
				if ("<%=convos[0].time%>" == "No convo scheduled"){
					document.getElementById('convo-date0').innerHTML = "No convo scheduled"
				}
				else {
					document.getElementById('convo-date0').innerHTML = new Date(parseInt("<%=convos[0].time%>", 10))
				}
				if ("<%=convos[1].time%>" == "No convo scheduled") {
					document.getElementById('convo-date1').innerHTML = "No convo scheduled"
				}
				else {
					document.getElementById('convo-date1').innerHTML = new Date(parseInt("<%=convos[1].time%>", 10))
				} 	
			}
			else{
				document.getElementById('convo-date0').innerHTML = new Date(parseInt("<%=convos[0].time%>", 10))
				document.getElementById('convo-date1').innerHTML = new Date(parseInt("<%=convos[1].time%>", 10))
			}
			var d = new Date()
			document.getElementById('timezone').setAttribute('value', d.getTimezoneOffset()/60)
			document.getElementById('timezone2').setAttribute('value', d.getTimezoneOffset()/60)
			title = document.getElementById("convo-title").innerHTML;
			button = document.getElementById("go-to-convo-button").src;
			console.log(button);
			console.log(<%=host%>)
			if(<%=host%> == true || <%=admin%> == true){
				document.getElementById("create-convo-btn").style.visibility = "visible";
				document.getElementById("convobtn").style.visibility = "visible";
			}
			title = document.getElementById("article-title").innerHTML;
			if(title.length > 70){
			title = title.substring(0,70) + "...";
			document.getElementById("article-title").innerHTML = title;
			console.log(title);
			console.log("works!");
			console.log("Current url: ", window.location.href);
			
		}
	}
		
	</script>
</body>

</html>